name: Branch Build igor and push
 
on:
  workflow_call:
  push:
    branches:
    - OES-1.30.x

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Xmx6g -Xms6g
  CONTAINER_REGISTRY: quay.io/opsmxpublic
  K8S_DEPLOYMENT_NAME: spin-igor
  K8S_SERVICE_NAME: igor
  K8S_NAMESPACE: cvetarget

jobs:
  branch-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
         repository: yugaa22/igor-oes
         ref: refs/heads/OES-1.30.x
      - name: Deploy to Kubernetes
        uses: azure/k8s-set-context@v1
        with:
          kubeconfig: ${{ secrets.KUBECONFIG }}
          gittoken: ${{ secrets.GIT_TOKEN }}

      - name: update igor and push
        run: |
          kubectl -n ${{ env.K8S_NAMESPACE }} run cve-push-pod --image=alpine/git --restart=Never --command -- sh -c "export GIT_DISCOVERY_ACROSS_FILESYSTEM=1 && apk add --no-cache git && git clone https://github.com/yugaa22/cve-target.git && git config --global user.email "yugaa22@gmail.com" && git config --global user.name "yugaa22" && touch cve-target/default/service-settings/${{ env.K8S_SERVICE_NAME }}.yml && echo artifactId: tesginggg >> cve-target/default/service-settings/${{ env.K8S_SERVICE_NAME }}.yml &&  cd cve-target && ls -ltra && git add . && git commit  -m "updating igor image" && ls -ltra default/service-settings/ && cat default/service-settings/igor.yml && git push https://yugaa22:$gittoken@github.com/yugaa22/cve-target.git "
          
          #          kubectl -n ${{ env.K8S_NAMESPACE }} run cve-push-pod --image=alpine/git --restart=Never --command -- sh -c "export GIT_DISCOVERY_ACROSS_FILESYSTEM=1 && apk add --no-cache git && git clone https://github.com/yugaa22/cve-target.git && git config --global user.email "yugaa22@gmail.com" && git config --global user.name "yugaa22" && sleep 30d"
