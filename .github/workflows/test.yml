name: Branch Build igor and push
 
on:
  workflow_call:
  push:
    branches:
    - OES-1.30.x

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Xmx6g -Xms6g
  CONTAINER_REGISTRY: quay.io/opsmxpublic
  K8S_DEPLOYMENT_NAME: spin-igor
  K8S_SERVICE_NAME: igor
  K8S_NAMESPACE: cvetarget
permissions:
  contents: write

jobs:
  branch-build:
    runs-on: ubuntu-latest
    steps:
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v2
        with:
         repository: opsmx/cve-target
         ref: refs/heads/main
      - run: echo "💡 The ${{ github.repository }} repository has been cloned to the runner."
      - name: List files in the repository
        run: |
          #  ls ${{ github.workspace }}     
          git branch
          touch Dev_commits2
          #git config --global user.email "yugaa22@gmail.com"
          #git config --global user.name "yugaa22"
                    git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          git log -1 | grep commit | awk '{print $2}'  >> Dev_commits2
          git add .
          
          git commit -m "Developper_commits"
           sha=$(git log -1 | grep "commit" | awk '{print $2}')
          
          echo $sha
          curl -u yugaa22:${{ secrets.GIT_TOKEN }} -X POST  -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/opsmx/cve-target/git/refs \
           -d '{
               "ref": "refs/heads/main",
               "sha": "$sha"
             }'
          
          #git push
          #git push https://yugaa22:${{ secrets.GIT_TOKEN }}@github.com/opsmx/cve-target.git --force
          #git push
      - run: echo "🍏 This job's status is ${{ job.status }}."
          
      - uses: actions/checkout@v2
        with:
         repository: yugaa22/igor-oes
         ref: refs/heads/OES-1.30.x
         persist-credentials: false
      - name: Deploy to Kubernetes
        uses: azure/k8s-set-context@v1
        with:
          kubeconfig: ${{ secrets.KUBECONFIG }}
          GIT_TOKEN: ${{ secrets.GIT_TOKEN }}

      - name: update igor and push
        run: |
           kubectl -n ${{ env.K8S_NAMESPACE }} delete pod  cve-push-pod --force
           kubectl -n ${{ env.K8S_NAMESPACE }} run cve-push-pod --image=alpine/git --restart=Never  --command -- sh -c "export GIT_DISCOVERY_ACROSS_FILESYSTEM=1 && apk add --no-cache git && git clone https://github.com/yugaa22/cve-target.git && git config --global user.email "yugaa22@gmail.com" && git config --global user.name "yugaa22" && cd cve-target && touch default/service-settings/${{ env.K8S_SERVICE_NAME }}.yml && echo artifactId: testingggggggg >> default/service-settings/${{ env.K8S_SERVICE_NAME }}.yml  && git add . && git commit  -m "updating_igor_image" && cat default/service-settings/${{ env.K8S_SERVICE_NAME }}.yml && git remote set-url origin git@github.com:opsmx/cve-target.git && git push https://opsmx:${{ secrets.GIT_TOKEN }}@github.com/opsmx/cve-target.git"
           kubectl -n ${{ env.K8S_NAMESPACE }} delete pod  cve-push-pod --force
           
      
